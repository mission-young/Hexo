title: windows rdp服务开启
author: 远方
date: 2020-08-12 22:56:15
tags:
---
经过对办公室电脑一系列猛如虎的操作(安装rdpwrapper、升级企业版、升级专业版)但依旧无法远程连接rdp之后，我几乎放弃了rdp这条路，无奈地向向日葵投降。虽然能够通过网云穿和utools NAT来访问办公室电脑的jupyter服务，但处理起来数据总归是不太爽。看看高额的蒲公英rdp映射服务，还是放弃了氪金。然而，俗话说，“有志者，事竟成”，在不懈的坚持下，还是成功地得以在家连上办公室的电脑。Bingo！

远程桌面的访问其实分为三个部分：

## 远程桌面服务器的搭建

其实用搭建这个词不算很合适，但一时找不到合适的词，暂用此。`win10`家庭版比较尴尬的一点是，并不自带远程桌面服务器，只有企业版和专业版提供。尽管我们可以用`Github`的`RDP wrapper`来‘曲线救国’，但在当时测试时，也是bug连连，及其烦人。为了省事起见，先是用密钥升级了企业版，又用密钥升级了专业版...(我也不懂为啥当初有这种神奇操作)。考虑到使用的是公司的电脑，会不会产生法律风险。。。暂时还不知道，先不管了。

## 公网ip

这一步也是最为烦人的一步。我之前的`vps`服务器基本到期，没有额外的公网ip做映射。网云穿等一些列服务商也由于政策原因(真的，还是接口？)，关闭了免费的3389映射服务，并将其设为收费专线服务，一年几百大洋，太黑了。一想到自己搭建`vps`，还得买主机，配置`frp`，妈耶，要疯了。

后来发现了知乎上有人推荐的两款工具，[SakuraLauncher](http://www.natfrp.com)和[ZeroTiger](http://www.zerotier.com). 前者是基于`frp`，开放了免费的`frp`服务线路，后者应用`VPN异地组网技术`。简单的设置后，即可实现公网`ip`的映射。

## rdp服务开启

理论上来说，以上两步完成之后，就已经可以愉快地远程办公了。但很不幸，failed。

防火墙的问题？关闭防火墙也不行。允许应用通过防火墙？该通过不该通过的都通过了也不行... = = 

看着`frp log`不断地报错，心都要碎了。一直拒绝、拒绝、拒绝连接。以为是有其他应用抢占`3389`端口，但用 `netstat -ano | findstr 3389` 一直为空。

此时，灵光一现，这他喵不会是没有开启远程桌面服务导致的吧？然后赶快把本机执行了一下上面命令：

![upload successful](/images/pasted-12.png)

你说尴尬不尴尬，办公室那台，没有开启3389服务？什么鬼，我明明什么都没有做啊！

硬着头皮上网搜，“如何开启3389服务”，找到救命稻草[cmd开启3389](https://www.cnblogs.com/dsli/p/7452535.html)
启发下，打开注册表，定位到`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Terminal Server`，修改`fDenyTSConnections`的字段为`0`，即不阻止远程连接。

备注：修改端口可以通过修改`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\Wds\rdpwd\Tds\tcp`字段`PortNumber`来实现。

##  总结
回顾这一路，也是坑位连连。有系统的限制、网络资源的限制以及潜在的各种深坑。其中注册表那部分最初最令人困惑。怀疑是从家庭版升级到企业版后，安全策略会禁止远程访问，导致注册表字段修改。而升级到专业版后，则继承了这一点。表现为系统设置处显示可用，但本地并没监听3389端口，导致实际无法连接。
![upload successful](/images/pasted-13.png)